# This docker image is not used for any of the CI jobs, but you can use it if you want to run Templight (https://github.com/mikael-s-persson/templight/tree/release_60), a tool that can be used to profile and debug template compilation.
# It is probably not a good idea to run templight on the full build, so only use it to compile a single file you want to profile.
FROM gitlabregistry.pep.cs.ru.nl/pep/docker-build/build-ubuntu-1804:master

ARG llvm_source_dir=/llvm/src
ARG llvm_build_dir=/llvm/build
ARG templight_tools_source_dir=/templight-tools/src
ARG templight_tools_build_dir=/templight-tools/build

RUN apt-get update && apt-get install -y subversion ninja-build && apt-get clean && rm -rf /var/cache/* /var/lib/{apt,dpkg,cache,log}/* /tmp/* /var/tmp/* \
  && mkdir -p ${llvm_source_dir} && mkdir -p ${llvm_build_dir} \
  && echo "Downloading sources" \
  && svn co --quiet http://llvm.org/svn/llvm-project/llvm/branches/release_60 ${llvm_source_dir} \
  && svn co --quiet http://llvm.org/svn/llvm-project/cfe/branches/release_60 ${llvm_source_dir}/tools/clang \
  && cd ${llvm_source_dir}/tools/clang/tools \
  && mkdir templight \
  && git clone https://github.com/mikael-s-persson/templight.git templight \
  && cd templight \
  && git checkout release_60 \
  && cd ${llvm_source_dir}/tools/clang \
  && svn patch tools/templight/templight_clang_patch.diff \
  && cd ${llvm_source_dir}/tools/clang/tools \
  && echo "add_clang_subdirectory(templight)" >> CMakeLists.txt \
  && cd ${llvm_build_dir} \
  && echo "Building clang/templight" \
  && cmake -G Ninja -DLLVM_USE_LINKER=gold ${llvm_source_dir} \
  && ninja -j1 \
  && ninja install \
  && echo "Downloading and building templight-tools" \
  && mkdir -p ${templight_tools_source_dir} && mkdir -p ${templight_tools_build_dir} \
  && git clone https://github.com/mikael-s-persson/templight-tools.git ${templight_tools_source_dir} \
  && cd ${templight_tools_build_dir} \
  && cmake ${templight_tools_source_dir} \
  && make \
  && make install \
  && rm -rf ${llvm_source_dir} ${llvm_build_dir} ${templight_tools_source_dir} ${templight_tools_build_dir} \
  && apt-get purge --auto-remove subversion ninja-build
