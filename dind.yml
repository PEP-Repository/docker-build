# dind.yml in pep/core> and pep/docker-build> should ideally be kept in sync

# Docker-in-Docker doesn't cache images.
# This file was originally created to easily switch between actual DinD and fake DinD:
# spinning up sibling containers by connecting to the host (unix:///var/run/docker.sock), which enables using the host cache,
# see https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/#the-socket-solution.
# However, this posed problems with bind mounts, which then cannot mount directories inside the container,
# see https://gitlab.pep.cs.ru.nl/pep/core/-/issues/2484#note_44341.
# Instead, we now use it to nicely manage the single common DinD config.

.dind-dind:
  services:
    # This image spins up dockerd
    - name: docker:dind
      # Use our caching registry mirror if available,
      # see the linux-runner VM YAML in pep/ops> and https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#enable-registry-mirror-for-dockerdind-service
      command: [--registry-mirror, http://mirror:5000]
  # May be overridden by another image containing docker
  image: docker
  variables:
    # Certificates are necessary if we want to do TLS verification for DinD when connecting to the docker daemon.
    # These get generated by the docker:dind service and mounted by the gitlab-runner.
    # However, it requires certain configuration in the job image that is present in the standard `docker` image,
    # but not in our Ubuntu-based builder image: https://github.com/docker-library/docker/blob/49e7a0aa907a6033c2482efbf8e25bb97588b184/27/cli/Dockerfile#L155-L166,
    # which includes script https://github.com/docker-library/docker/blob/49e7a0aa907a6033c2482efbf8e25bb97588b184/27/cli/docker-entrypoint.sh.
    # We could copy this config + script, but it's probably not worth it, since we trust the linux-runner VM we're running in anyway.
    # Instead, we set this to empty instead of /certs to disable TLS verification.
    # See https://hub.docker.com/_/docker
    DOCKER_TLS_CERTDIR: ''
    # The same script that is missing from our builder image would also set the address of the docker daemon to connect with,
    # instead of the default unix:///var/run/docker.sock, so we have to manually set this as well.
    # With TLS we would have used port 2376, which is also why we get an error that we cannot connect to tcp://docker:2375
    # if we had TLS enabled without the configuration in the job image.
    DOCKER_HOST: tcp://docker:2375

.dind:
  extends: .dind-dind
  tags:
    # Note that we cannot use a runner which has /var/run/docker.sock mounted (as with fake DinD),
    # as this will render the socket busy and unusable for DinD
    - docker

.dind-small:
  extends: .dind-dind
  tags:
    - docker-small
